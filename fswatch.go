// Package fswatch implements a simple interface for filesystem notifications.
package fswatch

import (
	"github.com/fswatch/fswatch/internal"
	"github.com/fswatch/fswatch/internal/poller"
)

// EventType is the type of events generated by a Watcher.
type EventType int

const (
	NOTHING  = EventType(internal.NOTHING)  // nothing happened
	CREATED  = EventType(internal.CREATED)  // something was created
	DELETED  = EventType(internal.DELETED)  // something was deleted
	MODIFIED = EventType(internal.MODIFIED) // contents were modified
	OTHER    = EventType(internal.OTHER)    // something else (metadata?) was modified
)

const OptionGenericPoller = "-generic-poller-"

type Observer interface {
	// Observe the event ev on the watched path.
	// If an error is returned, the observer is not called again.
	Observe(path string, ev EventType) error
}

type Watcher struct {
	w watcher
}

func New(opts map[string]interface{}) *Watcher {
	if opts != nil {
		if _, ok := opts[OptionGenericPoller]; ok {
			return &Watcher{
				w: watcher(poller.New(opts)),
			}
		}
	}

	return &Watcher{
		w: newImpl(opts),
	}
}

// File watches a single file, calling the observer with any events.
// With a file, the only Events possible are:
//   - MODIFIED indicates that the contents were modified
//   - OTHER indicates changes to metadata or other OS features:
//     permissions, access time, link count, etc.
//   - DELETED indicates that the watched file was removed.
//     No further events will be generated for the file.
func File(path string, obs Observer) (cancel func(), err error) {
	return wrapFiles(impl, []string{path}, obs)
}

// Files watches a list of files, calling the observer with any events.
// Only MODIFIED, OTHER, and DELETED events will be observed.
// See the File method for details about these event types.
func Files(paths []string, obs Observer) (cancel func(), err error) {
	return wrapFiles(impl, paths, obs)
}
